name: ESLint Check

on:
    pull_request:
        branches:
            - main
            - "feature/**"

jobs:
    eslint:
        runs-on: ubuntu-latest

        steps:
            # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            - name: Checkout repository
              uses: actions/checkout@v3

            # Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20

            # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            - name: Install dependencies
              run: pnpm install

            # ESLint ã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã° CI ãŒèµ¤ã«ãªã‚‹ï¼‰
            - name: Run ESLint
              id: eslint
              run: pnpm exec eslint . --format json --output-file eslint-report.json

            # PR ã« ESLint çµæžœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å‡ºåŠ›
            - name: Post ESLint results to PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const reportFile = 'eslint-report.json';
                      if (!fs.existsSync(reportFile)) {
                        console.log('No ESLint report found');
                        return;
                      }

                      const report = JSON.parse(fs.readFileSync(reportFile, 'utf-8'));
                      let message = '';

                      report.forEach(file => {
                        if (file.messages.length > 0) {
                          message += `**${file.filePath}**\n`;
                          file.messages.forEach(msg => {
                            message += `- Line ${msg.line}, Col ${msg.column}: ${msg.message} (${msg.ruleId})\n`;
                          });
                        }
                      });

                      const body = message
                        ? `ðŸ›‘ ESLint found some issues:\n\n${message}`
                        : 'âœ… ESLint: No issues found!';

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body,
                      });
