name: ESLint Check

on:
    pull_request:
        branches:
            - main
            - "feature/**"

jobs:
    eslint:
        runs-on: ubuntu-latest

        steps:
            # リポジトリをチェックアウト
            - name: Checkout repository
              uses: actions/checkout@v3

            # Node.js をセットアップ
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20

            # 依存関係をインストール
            - name: Install dependencies
              run: pnpm install

            # ESLint を実行（エラーがあれば CI が赤になる）
            - name: Run ESLint
              id: eslint
              run: pnpm exec eslint . --format json --output-file eslint-report.json

            # PR に ESLint 結果をコメントとして出力
            - name: Post ESLint results to PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const reportFile = 'eslint-report.json';
                      if (!fs.existsSync(reportFile)) {
                        console.log('No ESLint report found');
                        return;
                      }

                      const report = JSON.parse(fs.readFileSync(reportFile, 'utf-8'));
                      let message = '';

                      report.forEach(file => {
                        if (file.messages.length > 0) {
                          message += `**${file.filePath}**\n`;
                          file.messages.forEach(msg => {
                            message += `- Line ${msg.line}, Col ${msg.column}: ${msg.message} (${msg.ruleId})\n`;
                          });
                        }
                      });

                      const body = message
                        ? `🛑 ESLint found some issues:\n\n${message}`
                        : '✅ ESLint: No issues found!';

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body,
                      });
